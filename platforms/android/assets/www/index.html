<!DOCTYPE html>
<html>
  <head>
    <title>Device Properties Example</title>

    <script type="text/javascript" charset="utf-8" src="cordova.js"></script>
    <script type="text/javascript" charset="utf-8">

    // Wait for device API libraries to load
    //
    document.addEventListener("deviceready", onDeviceReady, false);

    var watchID = null;

	var gpsOptions = {
		enableHighAccuracy: true, 
		maximumAge: 1000, 
		//frequency: 2500,
		timeout : 1000 * 60 * 4,
	};
	
	var lastTime = 0;
	
	function startGps() {
        watchID = navigator.geolocation.watchPosition(onSuccess, onError, gpsOptions);
        lastTime = Date.now();
	};
	
    // device APIs are available
    //
    function onDeviceReady() {
        
        // Get the most accurate position updates available on the
        // device.
        		
		startGps();
        
    }


    // onSuccess Geolocation
    //
    function onSuccess(position) {
		//console.log("success");
		lastTime = Date.now();
        var element = document.getElementById('geolocation');
        element.innerHTML = 'Latitude: '  + position.coords.latitude      + '<br />' +
                            'Longitude: ' + position.coords.longitude     + '<br />' +
                            '<hr />'      + element.innerHTML;
    }

    // clear the watch that was started earlier
    //
    function clearWatch() {
        if (watchID != null) {
            navigator.geolocation.clearWatch(watchID);
            watchID = null;
        }
    }

	function restartGps() {
		num_errors = 0;
		clearWatch();
		startGps();
	};

	var interval_timeout = 3000;

	setInterval(function() {
		
		if(Date.now() - lastTime >= interval_timeout) {
			var element = document.getElementById('geolocation');
			element.innerHTML = "Try to restart GPS...<br /><hr />" + element.innerHTML;
			restartGps();
		}
	}, interval_timeout)

	var num_errors = 0;

	// onError Callback receives a PositionError object
	//
	function onError(error) {
		//console.log("error");
		var element = document.getElementById('geolocation');
		element.innerHTML = "Error<br /><hr />" + element.innerHTML;
		num_errors++;
		
		if(num_errors >= 3) {
			element.innerHTML = "Too many errors, restarting GPS...<br /><hr />" + element.innerHTML;
			restartGps();
		}
		
	}

    </script>
  </head>
  <body>
    <p id="geolocation">Starting to watch location...</p>
        <button onclick="restartGps();">Restart GPS</button>
  </body>
</html>